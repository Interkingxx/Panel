#!/bin/bash

# =============================
# KINGVPN Menu - Adaptado a /root/KINGVPN
# =============================

INSTALL_DIR="/root/KINGVPN"
PORT_FILE="$INSTALL_DIR/port"
ENV_FILE="$INSTALL_DIR/.env"

# =============================
# Función para verificar si un puerto está en uso
# =============================
is_port_in_use() {
    local port=$1
    if lsof -i :$port > /dev/null 2>&1; then
        return 0
    else
        return 1
    fi
}

# =============================
# Función para iniciar el panel
# =============================
start_KINGVPN() {
    local port=$1

    if is_port_in_use $port; then
        echo "El puerto $port ya está en uso."
        return
    fi

    cd "$INSTALL_DIR" || { echo "Directorio no encontrado"; return; }

    # Cargando nvm
    [ -s "/root/.nvm/nvm.sh" ] && \. "/root/.nvm/nvm.sh"

    # Crear o actualizar .env
    touch "$ENV_FILE"

    grep -q "^PORT=" "$ENV_FILE" && sed -i "s/^PORT=.*/PORT=$port/" "$ENV_FILE" || echo "PORT=$port" >> "$ENV_FILE"
    grep -q '^NODE_ENV=' "$ENV_FILE" || echo 'NODE_ENV="production"' >> "$ENV_FILE"
    grep -q '^DATABASE_URL=' "$ENV_FILE" || echo "DATABASE_URL=\"file:$INSTALL_DIR/prisma/database.db\"" >> "$ENV_FILE"
    grep -q '^CSRF_SECRET=' "$ENV_FILE" || token1=$(node -e "console.log(require('crypto').randomBytes(100).toString('base64'));") && echo "CSRF_SECRET=\"$token1\"" >> "$ENV_FILE"
    grep -q '^JWT_SECRET_KEY=' "$ENV_FILE" || token2=$(node -e "console.log(require('crypto').randomBytes(100).toString('base64'));") && echo "JWT_SECRET_KEY=\"$token2\"" >> "$ENV_FILE"
    grep -q '^JWT_SECRET_REFRESH=' "$ENV_FILE" || token3=$(node -e "console.log(require('crypto').randomBytes(100).toString('base64'));") && echo "JWT_SECRET_REFRESH=\"$token3\"" >> "$ENV_FILE"
    grep -q '^ENCRYPT_FILES=' "$ENV_FILE" || echo 'ENCRYPT_FILES="7223fd56-e21d-4191-8867-f3c67601122a"' >> "$ENV_FILE"

    # Build del panel
    npm install --force >/dev/null 2>&1
    npm run build
    npx prisma migrate dev --preview-feature

    # Crear servicio systemd
    SERVICE_FILE="/etc/systemd/system/KINGVPN.service"
    cat > "$SERVICE_FILE" <<EOL
[Unit]
Description=KINGVPN
After=network.target

[Service]
LimitNOFILE=infinity
LimitNPROC=infinity
LimitMEMLOCK=infinity
LimitSTACK=infinity
LimitCORE=infinity
LimitAS=infinity
LimitRSS=infinity
LimitCPU=infinity
LimitFSIZE=infinity

Environment=NVM_DIR=/root/.nvm
Environment=PATH=/root/.nvm/versions/node/18.20.4/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
Type=simple
ExecStart=$INSTALL_DIR/menu
Restart=always
WorkingDirectory=$INSTALL_DIR

[Install]
WantedBy=multi-user.target
EOL

    systemctl daemon-reload
    systemctl enable KINGVPN.service
    systemctl start KINGVPN.service

    # Guardar puerto
    echo $port > "$PORT_FILE"
    echo "Iniciado con éxito"
}

# =============================
# Función para detener el panel
# =============================
stop_KINGVPN() {
    sudo systemctl stop KINGVPN.service
    sudo systemctl disable KINGVPN.service
    sudo rm -f /etc/systemd/system/KINGVPN.service
    sudo systemctl daemon-reload

    rm -f "$PORT_FILE"
    echo "Detenido con éxito"
}

# =============================
# Función para mostrar menú
# =============================
show_menu() {
    clear
    echo "------------------------------------------------"
    printf "|                 %-29s|\n" "KINGVPN"
    echo "------------------------------------------------"

    STATUS=0
    if [ ! -s "$PORT_FILE" ]; then
        printf "| Acceso: %-37s|\n" "Desactivado"
    else
        PORT=$(cat "$PORT_FILE")
        STATUS=1
        printf "| Acceso: %-37s|\n" "http://$(wget -qO- ipinfo.io/ip):$PORT"
    fi

    echo "------------------------------------------------"
    if [ "$STATUS" -eq 0 ]; then
        printf "| %-45s|\n" "1 - Iniciar Panel"
    else
        printf "| %-45s|\n" "1 - Detener Panel"
    fi
    printf "| %-45s|\n" "0 - Salir"
    echo "------------------------------------------------"
    echo
    read -p " --> Seleccione una opcion: " option

    case $option in
        1)
            if [ "$STATUS" -eq 0 ]; then
                read -p "Digite el puerto: " port
                while ! [[ $port =~ ^[0-9]+$ ]]; do
                    echo "Digite un puerto válido."
                    read -p "Digite el puerto: " port
                done
                start_KINGVPN $port
                read -p "> Panel iniciado con éxito. Presione cualquier tecla para volver al menú." dummy
            else
                stop_KINGVPN
                read -p "> Panel detenido con éxito. Presione cualquier tecla para volver al menú." dummy
            fi
            ;;
        0)
            exit 0
            ;;
        *)
            echo "Opción inválida. Presione cualquier tecla para volver al menú."
            read -n 1 dummy
            ;;
    esac
}

# =============================
# Loop principal del menú
# =============================
while true; do
    show_menu
done
